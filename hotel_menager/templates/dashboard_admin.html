<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Panel ZarzƒÖdzania Hotelem - Admin</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<style>
/* --- Dodatkowy CSS dla czatu --- */
.chat-window {
    border:1px solid #ccc;
    border-radius:10px;
    padding:10px;
    background:#f9f9f9;
    max-width:400px;
    display:flex;
    flex-direction:column;
    position:relative;
    margin-top:10px;
}
.chat-messages {
    flex:1;
    overflow-y:auto;
    margin-bottom:10px;
    max-height:300px;
}
.message.sent { background:#dcf8c6; text-align:right; padding:5px 10px; border-radius:10px; margin:5px 0; }
.message.received { background:#fff; text-align:left; padding:5px 10px; border-radius:10px; margin:5px 0; }
.close-chat {
    position:absolute;
    top:5px;
    right:5px;
    border:none;
    background:transparent;
    font-size:16px;
    cursor:pointer;
}
.chat-input { display:flex; gap:5px; }
.chat-input input { flex:1; padding:5px; border-radius:5px; border:1px solid #ccc; }
.chat-input button { padding:5px 10px; border-radius:5px; border:none; background:#007bff; color:white; cursor:pointer; }
</style>
</head>
<body>
<div class="container">
    <div class="main-container">
        <div class="sidebar">
            <div class="top-section">
                <h3>Menu</h3>
                <button onclick="showView('rooms')" id="roomsBtn" class="active">Lista</button>
                <button onclick="showView('users')" id="usersBtn">U≈ºytkownicy</button>
                <button onclick="showView('logs')" id="logsBtn">Logi</button>
                <button onclick="showView('tickets')" id="ticketsBtn">Zg≈Çoszenia</button>
            </div>
            <div class="bottom-section">
                <button onclick="logout()">Wyloguj</button>
            </div>
        </div>
        <div class="content">
            <!-- Lista Pokoi -->
            <div id="roomsList">
                <h2>Lista Pokoi</h2>
                <div id="roomsGrid" class="room-grid"></div>
                <div id="roomsPagination" class="pagination"></div>
                <!-- Formularz dodawania pokoi -->
                <form id="addRoomForm" style="display:none;">
                    <label>Numery pokoi (np. 101;102;103):</label>
                    <input type="text" id="roomNumbers" required>
                    <label>Typ pokoju:</label>
                    <select id="roomType">
                        <option value="single">Single</option>
                        <option value="double">Double</option>
                    </select>
                    <button type="button" onclick="addRooms()">Dodaj pokoje</button>
                </form>
            </div>

            <!-- U≈ºytkownicy -->
            <div id="usersSection" style="display:none;">
                <h2>U≈ºytkownicy</h2>
                <table id="usersTable">
                    <thead>
                        <tr><th>ID</th><th>Username</th><th>Rola</th><th>Akcje</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <button id="addUserToggle" class="addUserBtn">Dodaj u≈ºytkownika +</button>
                <form id="addUserForm" style="display:none;">
                    <label>Username:</label>
                    <input type="text" id="newUsername" required>
                    <label>Has≈Ço:</label>
                    <input type="password" id="newPassword" required>
                    <label>Rola:</label>
                    <select id="newRole">
                        <option value="admin">Admin</option>
                        <option value="user">User</option>
                    </select>
                    <button type="button" onclick="addUser()">Dodaj u≈ºytkownika</button>
                </form>
            </div>

            <!-- Logi -->
            <div id="logsSection" style="display:none;">
                <h2>Logi</h2>
                <input type="text" id="logSearch" placeholder="Szukaj po u≈ºytkowniku..." oninput="applyLogFilter()">
                <table id="logsTable">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Czas</th>
                            <th>Pok√≥j</th>
                            <th>U≈ºytkownik</th>
                            <th>Poprzedni stan</th>
                            <th>Nowy stan</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div id="logsPagination" class="pagination"></div>
            </div>

            <!-- Zg≈Çoszenia i czat -->
            <div id="ticketsSection" style="display:none;">
                <h2>Zg≈Çoszenia od u≈ºytkownik√≥w</h2>
                <div id="ticketsAdminList"></div> <!-- pozostaje lista zg≈Çosze≈Ñ -->

                <!-- Kontener dla wszystkich czat√≥w -->
                <div id="activeChats" class="chat-container"></div>

                <!-- Osadzony czat -->
                <div id="chatSection" class="chat-window" style="display:none;">
                    <button class="close-chat" onclick="closeChat()">‚úñ</button>
                    <div id="chatWindow" class="chat-messages"></div>
                    <div class="chat-input">
                        <input type="text" id="chatMessage" placeholder="Napisz wiadomo≈õƒá...">
                        <button onclick="sendChatMessage()">Wy≈õlij</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- Guzik trybu edycji -->
<button id="editToggle">üîß</button>
<div id="toast"></div>

<script>
let currentUserId = 1;
let currentLogPage = 1;
const logsPerPage = 16;
let allLogs = [];
let logSearchTerm = "";

let currentRoomPage = 1;
const roomsPerPage = 15;
let allRooms = [];
let editMode = false;


// --- TOAST ---
function showToast(message){
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'show';
    setTimeout(()=>{ toast.className = toast.className.replace('show',''); },3000);
}

// --- Widoki ---
function showView(view){
    document.getElementById('roomsList').style.display = view==='rooms'?'block':'none';
    document.getElementById('usersSection').style.display = view==='users'?'block':'none';
    document.getElementById('logsSection').style.display = view==='logs'?'block':'none';
    document.getElementById('ticketsSection').style.display = view==='tickets'?'block':'none';

    document.getElementById('roomsBtn').classList.toggle('active', view==='rooms');
    document.getElementById('usersBtn').classList.toggle('active', view==='users');
    document.getElementById('logsBtn').classList.toggle('active', view==='logs');
    document.getElementById('ticketsBtn').classList.toggle('active', view==='tickets');
}

// --- Logout ---
function logout(){ fetch('/logout').then(()=>window.location.href='/'); }

// --- Pokoje ---
async function loadRooms(page=1){
    const res = await fetch('/api/rooms');
    if(res.status===401){ window.location.href='/'; return; }
    allRooms = await res.json();
    allRooms.sort((a,b)=>parseInt(a.number)-parseInt(b.number));
    renderRooms(page);
}

function renderRooms(page=1){
    currentRoomPage = page;
    const start = (page-1)*roomsPerPage;
    const end = start+roomsPerPage;
    const rooms = allRooms.slice(start,end);

    const grid = document.getElementById('roomsGrid');
    grid.innerHTML='';
    rooms.forEach(room=>{
        const state = room.status;
        const card = document.createElement('div');
        card.className=`room-card room-${state} ${editMode?'editable':''}`;
        card.innerHTML = `
            ${editMode ? '<button class="delete-btn" onclick="deleteRoom('+room.id+')">x</button>' : ''}
            ${editMode ? '<button class="priority-btn" onclick="PrioritizeRoom('+room.id+')">!</button>' : ''}
            <h3>${room.priority==1 ? '‚ö†Ô∏è Pok√≥j '+room.number+' ‚ö†Ô∏è' : 'Pok√≥j '+room.number}</h3>
            <p>Typ: ${room.type}</p>
            <select onchange="changeState(${room.id}, this.value)" ${editMode?'disabled':''}>
              <option value="clean" ${state==='clean'?'selected':''}>Clean</option>
              <option value="dirty" ${state==='dirty'?'selected':''}>Dirty</option>
              <option value="occupied" ${state==='occupied'?'selected':''}>Occupied</option>
            </select>`;
        grid.appendChild(card);
    });

    const pagination = document.getElementById('roomsPagination');
    pagination.innerHTML='';
    const totalPages = Math.ceil(allRooms.length/roomsPerPage);
    for(let i=1;i<=totalPages;i++){
        const btn = document.createElement('button');
        btn.textContent=i;
        btn.className = (i===currentRoomPage)?'pageBtn active':'pageBtn';
        btn.onclick = ()=>renderRooms(i);
        pagination.appendChild(btn);
    }
}

async function changeState(id, value){
    await fetch(`/api/room/${id}`,{
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({status:value})
    });
    loadRooms(currentRoomPage);
}

document.getElementById('editToggle').addEventListener('click', ()=>{
    editMode = !editMode;
    document.getElementById('addRoomForm').style.display = editMode?'block':'none';
    renderRooms(currentRoomPage);
});

async function deleteRoom(id){
    if(!confirm('Na pewno usunƒÖƒá pok√≥j?')) return;
    const res = await fetch(`/api/room/${id}`,{method:'DELETE'});
    if(res.ok){ showToast('Pok√≥j usuniƒôty'); loadRooms(currentRoomPage); }
    else showToast('B≈ÇƒÖd przy usuwaniu pokoju.');
}

async function addRooms(){
    const numbers = document.getElementById('roomNumbers').value.split(';').map(n=>n.trim()).filter(Boolean);
    const type = document.getElementById('roomType').value;
    for(let num of numbers){
        await fetch('/api/rooms',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({number:num,type})
        });
    }
    showToast('Dodano pokoje!');
    document.getElementById('addRoomForm').reset();
    loadRooms(currentRoomPage);
}

// --- U≈ºytkownicy ---
async function loadUsers(){
    const res = await fetch('/api/users');
    if(res.status===401){ window.location.href='/'; return; }
    const users = await res.json();
    const tbody = document.querySelector('#usersTable tbody');
    tbody.innerHTML='';

    users.forEach(user=>{
        const tr = document.createElement('tr');
        const isCur = user.id === currentUserId;
        tr.innerHTML = `
            <td>${user.id}</td>
            <td>${user.username}</td>
            <td>${user.role}</td>
            <td>
                <button class="changePassBtn">Zmie≈Ñ has≈Ço</button>
                ${isCur ? '' : `<button class="deleteUserBtn">Usu≈Ñ</button>`}
            </td>
        `;
        tbody.appendChild(tr);

        tr.querySelector('.changePassBtn').addEventListener('click', ()=>changePassword(user.id));
        if(!isCur){
            tr.querySelector('.deleteUserBtn').addEventListener('click', ()=>deleteUser(user.id));
        }
    });
}

document.getElementById('addUserToggle').addEventListener('click', ()=>{
    const form = document.getElementById('addUserForm');
    form.style.display = form.style.display==='none'?'block':'none';
});

async function addUser(){
    const username = document.getElementById('newUsername').value;
    const password = document.getElementById('newPassword').value;
    const role = document.getElementById('newRole').value;

    const res = await fetch('/api/users',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({username,password,role})
    });

    if(res.ok){
        showToast('U≈ºytkownik dodany!');
        document.getElementById('addUserForm').reset();
        document.getElementById('addUserForm').style.display='none';
        loadUsers();
    }else{
        const err = await res.json();
        showToast(err.error || 'B≈ÇƒÖd dodawania u≈ºytkownika.');
    }
}

async function changePassword(id){
    const newPass = prompt('Nowe has≈Ço:');
    if(!newPass) return;
    await fetch(`/api/user/${id}/password`,{
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({password:newPass})
    });
    showToast('Has≈Ço zmienione!');
}

async function deleteUser(id){
    if(!confirm('Na pewno usunƒÖƒá u≈ºytkownika?')) return;
    const res = await fetch(`/api/user/${id}`,{method:'DELETE'});
    if(res.ok){ loadUsers(); showToast('U≈ºytkownik usuniƒôty!'); }
    else showToast('B≈ÇƒÖd przy usuwaniu.');
}

// --- Logi ---
async function loadLogs(page=1){
  const res = await fetch('/api/logs');
  if(res.status===401){ window.location.href='/'; return; }
  allLogs = await res.json();
  renderLogs(page);
}

function applyLogFilter(){
  logSearchTerm = document.getElementById('logSearch').value.toLowerCase();
  renderLogs(1);
}

function renderLogs(page=1){
  currentLogPage = page;
  let filtered = allLogs;
  if(logSearchTerm){
    filtered = allLogs.filter(l=> l.username && l.username.toLowerCase().includes(logSearchTerm));
  }
  const start=(page-1)*logsPerPage;
  const end=start+logsPerPage;
  const logs = filtered.slice(start,end);

  const tbody = document.querySelector('#logsTable tbody');
  tbody.innerHTML='';
  logs.forEach(log=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${log.date}</td>
      <td>${log.time}</td>
      <td>${log.room_number}</td>
      <td>${log.username}</td>
      <td>${log.previous.toUpperCase()}</td>
      <td>${log.new.toUpperCase()}</td>
    `;
    tbody.appendChild(tr);
  });

  const pagination=document.getElementById('logsPagination');
  pagination.innerHTML='';
  const totalPages=Math.ceil(filtered.length/logsPerPage);
  for(let i=1;i<=totalPages;i++){
    const btn=document.createElement('button');
    btn.textContent=i;
    btn.className=(i===currentLogPage)?'pageBtn active':'pageBtn';
    btn.onclick=()=>renderLogs(i);
    pagination.appendChild(btn);
  }
}

// --- Priorytet pokoju ---
async function PrioritizeRoom(id){
    const res = await fetch(`/api/room/${id}/priority`, {method:'PUT'});
    if(res.ok){
        showToast("Priorytet zmieniony!");
        loadRooms(currentRoomPage);
    }else{
        showToast("B≈ÇƒÖd przy zmianie priorytetu.");
    }
}

// --- Zg≈Çoszenia ---
const sessionUsername = "{{ session['username'] }}";
async function loadAdminTickets(){
    const res = await fetch('/api/tickets');
    const tickets = await res.json();
    const div = document.getElementById('ticketsAdminList');
    div.innerHTML='';

tickets.forEach(t=>{
    const ticketDiv = document.createElement('div');
    ticketDiv.innerHTML = `<strong>Zg≈Çoszenie od: ${t.username}</strong> - Pok√≥j ${t.room_number} | Status: ${t.status} 
        <button onclick="openChat(${t.id}, '${t.reason}')">Czat</button>
        ${t.status !== 'closed' ? `<button onclick="closeTicket(${t.id})" class="close-btn">Zamknij</button>` 
                                 : `<button onclick="deleteTicket(${t.id})" class="delete-btn">Usu≈Ñ</button>`}`;
    document.getElementById('ticketsAdminList').appendChild(ticketDiv);
});
}

// Funkcja zamykania zg≈Çoszenia
async function closeTicket(ticketId){
    if(!confirm('Na pewno zamknƒÖƒá zg≈Çoszenie?')) return;
    const res = await fetch(`/api/tickets/${ticketId}/close`, { method:'PUT' });
    if(res.ok){
        showToast('Zg≈Çoszenie zamkniƒôte!');
        loadAdminTickets();
    }else{
        const err = await res.json();
        showToast(err.error || 'B≈ÇƒÖd przy zamykaniu zg≈Çoszenia.');
    }
}

// --- Chat ---
async function openChat(ticketId, reason){
    // Sprawd≈∫, czy czat ju≈º istnieje
    if (document.getElementById(`chatSection-${ticketId}`)) return;

    const chatDiv = document.createElement('div');
    chatDiv.id = `chatSection-${ticketId}`;
    chatDiv.className = 'chat-window';
    chatDiv.innerHTML = `
        <div class="chat-header">
            <strong>Zg≈Çoszenie: ${reason}</strong>
            <button class="close-chat" onclick="closeChat(${ticketId})">‚úñ</button>
        </div>
        <div id="chatWindow-${ticketId}" class="chat-messages"></div>
        <div class="chat-input">
            <input type="text" id="chatMessage-${ticketId}" placeholder="Napisz wiadomo≈õƒá...">
            <button onclick="sendChatMessage(${ticketId})">Wy≈õlij</button>
        </div>
    `;

    document.getElementById('activeChats').appendChild(chatDiv);
    loadChat(ticketId);
}


function closeChat(ticketId) {
    const chatDiv = document.getElementById(`chatSection-${ticketId}`);
    if (chatDiv) chatDiv.remove();
}

async function loadChat(ticketId){
    const res = await fetch(`/api/tickets/${ticketId}/messages`);
    const messages = await res.json();
    const chatWin = document.getElementById(`chatWindow-${ticketId}`);
    chatWin.innerHTML = '';

    messages.forEach(m=>{
        const isAdmin = m.sender === sessionUsername;
        const msgDiv = document.createElement('div');
        msgDiv.className = 'message ' + (isAdmin ? 'sent':'received');
        msgDiv.innerHTML = `<strong>${m.sender}:</strong> ${m.message}`;
        chatWin.appendChild(msgDiv);
    });

    chatWin.scrollTop = chatWin.scrollHeight;
}

async function sendChatMessage(ticketId){
    const msgInput = document.getElementById(`chatMessage-${ticketId}`);
    const message = msgInput.value.trim();
    if(!message) return;

    await fetch(`/api/tickets/${ticketId}/messages`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({message})
    });
    msgInput.value='';
    loadChat(ticketId);
}

async function deleteTicket(ticketId){
    if(!confirm('Na pewno usunƒÖƒá to zamkniƒôte zg≈Çoszenie?')) return;
    const res = await fetch(`/api/tickets/${ticketId}`, { method:'DELETE' });
    if(res.ok){
        showToast('Zg≈Çoszenie usuniƒôte!');
        loadAdminTickets();
    }else{
        const err = await res.json();
        showToast(err.error || 'B≈ÇƒÖd przy usuwaniu zg≈Çoszenia.');
    }
}

// --- Inicjalizacja ---
loadAdminTickets();
showView('rooms');
loadRooms();
loadUsers();
loadLogs();
</script>
</body>
</html>
