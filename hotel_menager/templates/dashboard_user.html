<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Panel U≈ºytkownika - Pokoje</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="container">
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="top-section menu-buttons">
                <button onclick="showSection('rooms')" class="active">Lista Pokoi</button>
                <button onclick="showSection('reservations')">Rezerwacje</button>
                <button onclick="showSection('tickets')">Zg≈Çoszenia</button>
            </div>
            <div class="bottom-section">
                <button onclick="logout()">Wyloguj</button>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Lista Pokoi -->
            <div id="rooms" class="section">
                <h2>Lista Pokoi</h2>
                <div id="roomsGrid" class="room-grid"></div>
                <div id="roomsPagination" class="pagination"></div>
            </div>

            <!-- Rezerwacje -->
            <div id="reservations" class="section" style="display:none;">
                <h2>Rezerwacje</h2>
                <button id="toggleReservationForm" style="margin-bottom: 25px;">Poka≈º formularz rezerwacji</button>
                <div id="reservationFormContainer" style="display:none;">
                    <form id="reservationForm">
                        <input type="hidden" id="reservationId">
                        <label>Pok√≥j:</label>
                        <select id="reservationRoom"></select>
                        <label>Check-in:</label>
                        <input type="date" id="reservationCheckIn">
                        <label>Check-out:</label>
                        <input type="date" id="reservationCheckOut">
                        <button type="button" onclick="submitReservation()">Zapisz</button>
                    </form>
                </div>
                <table id="reservationsTable">
                    <thead>
                        <tr><th>Pok√≥j</th><th>Od</th><th>Do</th><th>Akcje</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

        <!-- Zg≈Çoszenia -->
        <div id="tickets" class="section" style="display:none;">
            <h2>Zg≈Çoszenia</h2>
            <button id="toggleTicketForm" style="margin-bottom: 25px;">Poka≈º formularz zg≈Çoszenia</button>
            <div id="ticketFormContainer" style="display:none;">
                <form id="ticketForm">
                    <label>Pok√≥j:</label>
                    <select id="ticketRoom"></select>
                    <label>Pow√≥d zg≈Çoszenia:</label>
                    <select id="ticketReason">
                        <option value="brudny pok√≥j">Brudny pok√≥j</option>
                        <option value="problem z urzƒÖdzeniem">Problem z urzƒÖdzeniem</option>
                        <option value="inne">Inne</option>
                    </select>
                    <input type="text" id="ticketMessage" placeholder="Dodatkowa wiadomo≈õƒá...">
                    <button type="button" onclick="sendTicket()">Wy≈õlij zg≈Çoszenie</button>
                </form>
            </div>
            <div id="ticketsList"></div>

            <!-- Osadzony czat -->
            <div id="chatSection" class="chat-window" style="display:none; position:relative;">
                <button class="close-chat" onclick="closeChat()">‚úñ</button>
                <div id="chatWindow" class="chat-messages"></div>
                <div class="chat-input">
                    <input type="text" id="chatMessage" placeholder="Napisz wiadomo≈õƒá...">
                    <button onclick="sendChatMessage()">Wy≈õlij</button>
                </div>
            </div>
        </div>
        </div>
    </div>
</div>

<!-- Guzik trybu edycji -->
<button id="editToggle">üßπ</button>
<!-- Licznik pokoi do sprzƒÖtania -->
<div id="editCounter">0</div>
<div id="toast"></div>

<script>
let currentRoomPage = 1;
const roomsPerPage = 12;
let allRooms = [];
let editMode = false;
let currentTicketId = null;
let currentUsername = null;
let reservations = [];

async function loadCurrentUser(){
    const res = await fetch('/api/me');
    if(res.ok){
        const data = await res.json();
        currentUsername = data.username;
    }
}

// Sidebar
function showSection(sectionId){
    document.querySelectorAll('.section').forEach(s=>s.style.display='none');
    document.getElementById(sectionId).style.display='block';
    document.querySelectorAll('.menu-buttons button').forEach(b=>b.classList.remove('active'));
    event.target.classList.add('active');
    if(sectionId==='reservations') loadReservations();
    if(sectionId==='tickets') loadTickets();
    if(sectionId==='rooms') loadRooms();
}

function showToast(msg){
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.className = 'show';
    setTimeout(()=>{ toast.className=''; },3000);
}

function logout(){
    fetch('/logout').then(()=>window.location.href='/');
}

// Pokoje
async function loadRooms(){
    const res = await fetch('/api/rooms');
    if(res.status===401){ window.location.href='/'; return; }
    allRooms = await res.json();
    allRooms.sort((a,b)=>parseInt(a.number)-parseInt(b.number));
    renderRooms(currentRoomPage);
    updateEditCounter();
}

function renderRooms(page=1){
    currentRoomPage = page;
    let filtered = allRooms.filter(r => editMode ? r.status==='dirty' : true);

    const start = (page-1)*roomsPerPage;
    const end = start + roomsPerPage;
    const rooms = filtered.slice(start,end);

    const grid = document.getElementById('roomsGrid');
    grid.innerHTML = '';
    rooms.forEach(r=>{
        let state = r.status==='occupied' ? 'room-occupied' : r.status==='clean' ? 'room-clean' : 'room-dirty';
        const card = document.createElement('div');
        card.className = `room-card ${state} ${editMode ? 'editable' : ''}`;
        card.innerHTML = `
            <h3>${r.priority==1 ? '‚ö†Ô∏è Pok√≥j '+r.number+' ‚ö†Ô∏è' : 'Pok√≥j '+r.number}</h3>
            <p>Typ: ${r.type}</p>
            <select onchange="changeStatus(${r.id}, this.value)" ${r.status==='occupied' ? 'disabled' : ''}>
                <option value="clean" ${r.status==='clean'?'selected':''}>Clean</option>
                <option value="dirty" ${r.status==='dirty'?'selected':''}>Dirty</option>
                <option value="occupied" disabled ${r.status==='occupied'?'selected':''}>Occupied</option>
            </select>
        `;
        grid.appendChild(card);
    });

    // Paginacja
    const pagination = document.getElementById('roomsPagination');
    pagination.innerHTML='';
    const totalPages = Math.ceil(filtered.length/roomsPerPage);
    for(let i=1;i<=totalPages;i++){
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = i===currentRoomPage ? 'pageBtn active' : 'pageBtn';
        btn.onclick = ()=>renderRooms(i);
        pagination.appendChild(btn);
    }

    updateEditCounter();
}

async function changeStatus(id, newStatus){
    const res = await fetch(`/api/room/${id}`, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({status: newStatus})
    });
    if(res.ok){ 
        showToast(`Zmieniono status pokoju!`); 
        loadRooms(); 
    } else {
        const data = await res.json();
        showToast(data.error || 'B≈ÇƒÖd!');
    }
}

document.getElementById('editToggle').addEventListener('click', ()=>{
    editMode = !editMode;
    renderRooms(1);
});

function updateEditCounter(){
    const count = allRooms.filter(r=>r.status==='dirty').length;
    const counter = document.getElementById('editCounter');
    counter.textContent = count;
    counter.style.background = count>0 ? '#e67e22' : '#27ae60';
}

// Rezerwacje
async function loadReservations(){
    const res = await fetch('/api/reservations');
    if(res.status===401){ window.location.href='/'; return; }
    reservations = await res.json();
    renderReservations();
}

function renderReservations(){
    const tbody = document.querySelector('#reservationsTable tbody');
    if(!tbody) return;
    tbody.innerHTML='';
    reservations.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.room_number}</td><td>${r.check_in}</td><td>${r.check_out}</td>`+
                       `<td><button onclick="editReservation(${r.id})">Edytuj</button> <button onclick="deleteReservation(${r.id})">Usu≈Ñ</button></td>`;
        tbody.appendChild(tr);
    });
}

async function loadRoomsForReservation(){
    const res = await fetch('/api/rooms');
    const rooms = await res.json();
    const sel = document.getElementById('reservationRoom');
    sel.innerHTML='';
    rooms.filter(r=>r.status!=='occupied').forEach(r=>{
        const opt = document.createElement('option');
        opt.value = r.id;
        opt.textContent = r.number;
        sel.appendChild(opt);
    });
}

document.getElementById('toggleReservationForm').addEventListener('click', ()=>{
    const container = document.getElementById('reservationFormContainer');
    if(container.style.display==='none'){
        container.style.display='block';
        document.getElementById('toggleReservationForm').textContent='Ukryj formularz rezerwacji';
        loadRoomsForReservation();
    } else {
        container.style.display='none';
        document.getElementById('toggleReservationForm').textContent='Poka≈º formularz rezerwacji';
        clearReservationForm();
    }
});

function clearReservationForm(){
    document.getElementById('reservationId').value='';
    document.getElementById('reservationForm').reset();
}

async function submitReservation(){
    const id = document.getElementById('reservationId').value;
    const room_id = document.getElementById('reservationRoom').value;
    const check_in = document.getElementById('reservationCheckIn').value;
    const check_out = document.getElementById('reservationCheckOut').value;
    const method = id ? 'PUT' : 'POST';
    const url = id ? `/api/reservations/${id}` : '/api/reservations';
    const res = await fetch(url,{
        method,
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({room_id, check_in, check_out})
    });
    const data = await res.json();
    if(res.ok){
        showToast('Zapisano rezerwacjƒô!');
        loadReservations();
        clearReservationForm();
        document.getElementById('reservationFormContainer').style.display='none';
        document.getElementById('toggleReservationForm').textContent='Poka≈º formularz rezerwacji';
    } else {
        showToast(data.error || 'B≈ÇƒÖd!');
    }
}

function editReservation(id){
    const r = reservations.find(x=>x.id===id);
    if(!r) return;
    document.getElementById('reservationId').value = r.id;
    document.getElementById('reservationCheckIn').value = r.check_in;
    document.getElementById('reservationCheckOut').value = r.check_out;
    document.getElementById('reservationFormContainer').style.display='block';
    document.getElementById('toggleReservationForm').textContent='Ukryj formularz rezerwacji';
    loadRoomsForReservation().then(()=>{ document.getElementById('reservationRoom').value = r.room_id; });
}

async function deleteReservation(id){
    if(!confirm('UsunƒÖƒá rezerwacjƒô?')) return;
    const res = await fetch(`/api/reservations/${id}`, {method:'DELETE'});
    const data = await res.json();
    if(res.ok){
        showToast('Usuniƒôto rezerwacjƒô!');
        loadReservations();
    } else {
        showToast(data.error || 'B≈ÇƒÖd!');
    }
}

// Rozwijanie formularza zg≈Çoszenia
document.getElementById('toggleTicketForm').addEventListener('click', () => {
    const container = document.getElementById('ticketFormContainer');
    if (container.style.display === 'none') {
        container.style.display = 'block';
        document.getElementById('toggleTicketForm').textContent = 'Ukryj formularz zg≈Çoszenia';
    } else {
        container.style.display = 'none';
        document.getElementById('toggleTicketForm').textContent = 'Poka≈º formularz zg≈Çoszenia';
    }
});
// Zg≈Çoszenia
async function loadRoomsForTicket(){
    const res = await fetch('/api/rooms');
    const rooms = await res.json();
    const sel = document.getElementById('ticketRoom');
    sel.innerHTML='';
    rooms.forEach(r=>{
        sel.innerHTML += `<option value="${r.id}">${r.number}</option>`;
    });
}

async function sendTicket(){
    const room_id = document.getElementById('ticketRoom').value;
    const reason = document.getElementById('ticketReason').value;
    const msg = document.getElementById('ticketMessage').value || reason;

    const res = await fetch('/api/tickets', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({room_id, reason: msg})
    });
    if(res.ok){ showToast('Zg≈Çoszenie wys≈Çane!'); loadTickets(); }
    else { showToast('B≈ÇƒÖd przy wysy≈Çaniu zg≈Çoszenia'); }
}

async function loadTickets(){
    const res = await fetch('/api/tickets');
    const tickets = await res.json();
    const div = document.getElementById('ticketsList');
    div.innerHTML = '';

    // Filtrowanie tylko otwartych zg≈Çosze≈Ñ
    const openTickets = tickets.filter(t => t.status === 'open');

    openTickets.forEach(t=>{
        div.innerHTML += `<div class="ticket-card">
            <strong>Pok√≥j ${t.room_number}</strong> | Status: ${t.status} | Utworzono: ${t.created_at}
            <button onclick="openChat(${t.id})">Czat</button>
        </div>`;
    });
}

async function openChat(ticket_id){
    currentTicketId = ticket_id;
    document.getElementById('chatSection').style.display='flex';
    loadChat();
}

async function loadChat(){
    if(!currentTicketId) return;
    const res = await fetch(`/api/tickets/${currentTicketId}/messages`);
    const messages = await res.json();
    const chatWin = document.getElementById('chatWindow');
    chatWin.innerHTML = '';
    messages.forEach(m=>{
        const isMine = (m.sender === currentUsername);
        const msgDiv = document.createElement('div');
        msgDiv.className = 'message ' + (isMine ? 'sent' : 'received');
        const sender = isMine ? 'Ty' : m.sender; // poka≈º "Ty" dla mnie, nazwƒô konta dla innych
        msgDiv.innerHTML = `<strong>${sender}:</strong> ${m.message}`;
        chatWin.appendChild(msgDiv);
    });
    chatWin.scrollTop = chatWin.scrollHeight;
}


// Funkcja zamykania czatu
function closeChat(){
    document.getElementById('chatSection').style.display='none';
    currentTicketId = null;
}

async function sendChatMessage(){
    const msgInput = document.getElementById('chatMessage');
    const msg = msgInput.value.trim();
    if(!msg) return;
    await fetch(`/api/tickets/${currentTicketId}/messages`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({message: msg})
    });
    msgInput.value='';
    loadChat();
}

setInterval(()=>{ if(currentTicketId) loadChat(); },2000);

// Inicjalizacja
loadCurrentUser();
loadRooms();
loadRoomsForTicket();
loadTickets();
loadReservations();
</script>
</body>
</html>
