<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Panel U≈ºytkownika - Pokoje</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<style>
/* Licznik pokoi do sprzƒÖtania */
#editCounter {
    position: fixed;
    bottom: 90px;
    right: 30px;
    color: white;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    transition: 0.3s;
    background: #27ae60;
}

/* Tryb edycji - brudne pokoje */
.room-card.editable { border: 2px dashed #e67e22; }

/* Toast */
#toast {
    visibility: hidden;
    min-width: 200px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 5px;
    padding: 10px;
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.5s, visibility 0.5s;
}
#toast.show { visibility: visible; opacity: 1; }
</style>
</head>
<body>
<div class="container">
    <div class="main-container">
        <div class="sidebar">
            <h3>Menu</h3>
                <div class="bottom-section">
        <button onclick="logout()">Wyloguj</button>
    </div>
        </div>
        <div class="content">
            <h2>Lista Pokoi</h2>
            <div id="roomsGrid" class="room-grid"></div>
            <div id="roomsPagination" class="pagination"></div>
        </div>
    </div>
</div>

<!-- Guzik trybu edycji -->
<button id="editToggle">üßπ</button>
<!-- Licznik pokoi do sprzƒÖtania -->
<div id="editCounter">0</div>

<div id="toast"></div>

<script>
let currentRoomPage = 1;
const roomsPerPage = 12;
let allRooms = [];
let editMode = false;

function showToast(msg){
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.className = 'show';
    setTimeout(()=>{ toast.className=''; },3000);
}

function logout(){
    fetch('/logout').then(()=>window.location.href='/');
}

async function loadRooms(){
    const res = await fetch('/api/rooms');
    if(res.status===401){ window.location.href='/'; return; }
    allRooms = await res.json();
    allRooms.sort((a,b)=>parseInt(a.number)-parseInt(b.number));
    renderRooms(currentRoomPage);
    updateEditCounter();
}

function renderRooms(page=1){
    currentRoomPage = page;

    // Je≈õli editMode, pokazujemy tylko dirty pokoje, inaczej wszystkie
    let filtered = allRooms.filter(r => editMode ? r.status==='dirty' : true);

    const start = (page-1)*roomsPerPage;
    const end = start + roomsPerPage;
    const rooms = filtered.slice(start,end);

    const grid = document.getElementById('roomsGrid');
    grid.innerHTML = '';
    rooms.forEach(r=>{
        let state = r.status==='occupied' ? 'room-occupied' : r.status==='clean' ? 'room-clean' : 'room-dirty';
        const card = document.createElement('div');
        card.className = `room-card ${state} ${editMode ? 'editable' : ''}`;
        card.innerHTML = `
            <h3>${r.priority==1 ? '‚ö†Ô∏è Pok√≥j '+r.number+' ‚ö†Ô∏è' : 'Pok√≥j '+r.number}</h3>
            <p>Typ: ${r.type}</p>
<select onchange="changeStatus(${r.id}, this.value)" ${r.status==='occupied' ? 'disabled' : ''}>
    <option value="clean" ${r.status==='clean'?'selected':''}>Clean</option>
    <option value="dirty" ${r.status==='dirty'?'selected':''}>Dirty</option>
    <option value="occupied" disabled ${r.status==='occupied'?'selected':''}>Occupied</option>
</select>
        `;
        grid.appendChild(card);
    });

    // Paginacja
    const pagination = document.getElementById('roomsPagination');
    pagination.innerHTML='';
    const totalPages = Math.ceil(filtered.length/roomsPerPage);
    for(let i=1;i<=totalPages;i++){
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = i===currentRoomPage ? 'pageBtn active' : 'pageBtn';
        btn.onclick = ()=>renderRooms(i);
        pagination.appendChild(btn);
    }

    updateEditCounter();
}

// Zmiana statusu pokoju (tylko dirty ‚Üí clean dla usera)
async function changeStatus(id, newStatus){
    const res = await fetch(`/api/room/${id}`, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({status: newStatus})
    });
    if(res.ok){ 
        showToast(`Zmieniono status pokoju!`); 
        loadRooms(); 
    } else {
        const data = await res.json();
        showToast(data.error || 'B≈ÇƒÖd!');
    }
}

// Guzik trybu edycji
document.getElementById('editToggle').addEventListener('click', ()=>{
    editMode = !editMode;
    renderRooms(1);
});

// Licznik pokoi do sprzƒÖtania
function updateEditCounter(){
    const count = allRooms.filter(r=>r.status==='dirty').length;
    const counter = document.getElementById('editCounter');
    counter.textContent = count;
    counter.style.background = count>0 ? '#e67e22' : '#27ae60';
}

loadRooms();
</script>
</body>
</html>
